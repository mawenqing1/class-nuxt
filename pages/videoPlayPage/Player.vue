<script lang="ts" setup>
import videojs from 'video.js'
import 'video.js/dist/video-js.css'
import { IChapter } from '~/types/api'
import vueDanmaku from 'vue3-danmaku/dist/vue3-danmaku.esm'

const { productId, episodeId, chapterList } = defineProps<{
  productId: number
  episodeId: number
  chapterList: any
}>()

const emit = defineEmits<{ (e: 'getVideoData', value: number): void }>()

/**
 * 弹幕逻辑
 */
let danmakuRef = $ref<InstanceType<typeof vueDanmaku>>()

/**
 * 实例化播放器
 */
let oVideo: HTMLVideoElement // 获取video DOM
let oDanmu: HTMLDivElement // 获取弹幕 DOM
let myPlay = $ref(null)
let init = $ref(false) // 控制弹幕展示时机
let player: videojs.Player | null = null


let newPlayer = async (playSrc: string) => {
  if (process.server) return
  if (!player) {
    player = videojs(myPlay, {
      controls: true, // 控制器
      fill: true, // 填充模式
      playbackRates: [0.5, 1, 1.25, 1.5, 1.75, 2.0],
    })
    init = true

    player.on('play', onPlayerPlay) // 播放器开始
    player.on('pause', onPlayerPause) // 播放器暂停
    player.on('loadedmetadata', onPlayerReady) // 播放器加载完成
    player.on('ended', nextEpisod)  // 播放器结束
  }
  player.src({
    src: playSrc,
    type: 'application/x-mpegURL' // 流设置: m3u8
  })
}

// 当播放器暂停的时候弹幕暂停
const onPlayerPause = function () {
  danmakuRef?.pause()
}

// 当播放器播放时候滚动弹幕
const onPlayerPlay = function () {
  danmakuRef?.play()
}

// 当播放器加载好的时候初始化dom
const onPlayerReady = async function () {
  oVideo = document.querySelector('.vjs-tech') as HTMLVideoElement
  oDanmu = document.querySelector('#_danmu') as HTMLDivElement

  // 设置弹幕的显示位置
  nextTick(() => {
    oDanmu.style.width = `${oVideo.offsetWidth}px`
    oDanmu.style.height = `${oVideo.offsetHeight}px`
    oDanmu.style.top = '0'
    oDanmu.style.left = '0'
    oDanmu.style.zIndex = '1000'
    oDanmu.style.position = 'absolute'
    oDanmu.style.pointerEvents = 'none'
  })
  // 视频自动播放
  player.play()
}

// 视频播放结束自动切换本章下一集
function nextEpisod() {
  (chapterList as IChapter[]).forEach((item) => {
    item.episodeList.forEach((subItem, subIndex) => {
      // 如果真实集数据不存在改集 终止
      if (episodeId !== subItem.id) return
      // 该集是否有下一集，有的话请求下一集播放地址
      if (subIndex + 1 < item.episodeList.length) {
        emit('getVideoData', item.episodeList[subIndex + 1].id)
      } else {
        // 跨章时暂停
      }
    })
  })
}

// 组件即将销毁时删除播放器
onBeforeUnmount(() => {
  if (player) player.dispose()
})

defineExpose({ newPlayer })

const danmuList = [
  {
    head_img: "https://file.xdclass.net/user_file/2022/09/60027b661a6738f62d5b44834484477d.jpeg",
    content: '啊实打实多多',
    style: 'COMMON_1'
  },
  {
    head_img: "https://file.xdclass.net/user_file/2022/09/60027b661a6738f62d5b44834484477d.jpeg",
    content: '啊实打实多多',
    style: 'COMMON_2'
  },
  {
    head_img: "https://file.xdclass.net/user_file/2022/09/60027b661a6738f62d5b44834484477d.jpeg",
    content: '啊实打实多多',
    style: 'COMMON_3'
  },
  {
    head_img: "https://file.xdclass.net/user_file/2022/09/60027b661a6738f62d5b44834484477d.jpeg",
    content: '啊实打实多多',
    style: 'COMMON_4'
  },
  {
    head_img: "https://file.xdclass.net/user_file/2022/09/60027b661a6738f62d5b44834484477d.jpeg",
    content: '啊实打实多多',
    style: 'COMMON_5'
  },
]

</script>

<template>
  <Teleport v-if="init" to=".video-js">
    <div id="_danmu">
      <vueDanmaku style="width: 100%; height: 100%" ref="danmakuRef" v-model:danmus="danmuList" :channels="5"
        :autoplay="false" :speeds="160" useSlot>
        <template v-slot:dm="{ danmu }">
          <div flex items-center>
            <img :src="danmu.head_img" wh-25 rounded-full />
            <span class="TEXT" :class="danmu.style">{{ danmu.content }}</span>
          </div>
        </template>
      </vueDanmaku>
    </div>
  </Teleport>
  <video ref="myPlay" controls style="height: 100%; width: 100%"
    class="video-js vjs-default-skin vjs-big-play-centered" />
</template>

<style scoped>
.TEXT {
  font-size: 20px;
  font-weight: bold;
  color: transparent;
  background-clip: text;
}

.PLANT {
  color: white;
  -webkit-text-stroke: 2px black;
}

.COMMON_1 {
  background-image: linear-gradient(90deg, #fdb34b 0%, #fbe36c 98.57142857142858%);
}

.COMMON_2 {
  background-image: linear-gradient(90deg, #5094ea 0%, #5d41ba 45.34285714285714%, #c669a0 98.57142857142858%);
}

.COMMON_3 {
  background-image: linear-gradient(90deg, #fdb34b 0%, #fbe36c 98.57142857142858%);
}

.COMMON_4 {
  background-image: linear-gradient(90deg, #5094ea 0%, #5d41ba 45.34285714285714%, #c669a0 98.57142857142858%);
}

.COMMON_5 {
  background-image: linear-gradient(90deg, #fe4d5f 0%, #ffc666 98.57142857142858%);
}

.VIP_1 {
  background-image: linear-gradient(90deg, #785cc8 0%, #854edb 98.57142857142858%);
}

.VIP_2 {
  background-image: linear-gradient(90deg, #254abd 0%, #7dabef 98.57142857142858%);
}

.VIP_3 {
  background-image: linear-gradient(90deg, #cf45e7 0%, #d967e3 98.57142857142858%);
}

.VIP_4 {
  background-image: linear-gradient(90deg, #fdb34b 0%, #fbe36c 98.57142857142858%);
}

.VIP_5 {
  background-image: linear-gradient(90deg, #785cc8 0%, #854edb 98.57142857142858%);
}

.VIP_TRAIN_1 {
  background-image: linear-gradient(90deg, #fcb64f 0%, #ffb105 98.57142857142858%);
}

.VIP_TRAIN_2 {
  background-image: linear-gradient(0deg, #bb4444 0%, #f66d68 90.81349206349216%);
}

.TRAIN_1 {
  background-image: linear-gradient(-180deg, #ecc27d 9.186507936507835%, #b76420 100%);
}

.TRAIN_2 {
  background-image: linear-gradient(-180deg, #2e6ec4 9.186507936507835%, #4252c4 100%);
}
</style>
